#!/usr/bin/env ruby

require 'rirera'
require 'trollop'

def input
  begin
    while true do
      system "clear"
      broker = Rirera.get_broker(@opts[:broker])
      print "volume: "
      volume = Rirera.sanity_check($stdin.gets)
      print "target price: "
      target = Rirera.sanity_check($stdin.gets)
      print "actual price: "
      actual = Rirera.sanity_check($stdin.gets)
      stop = nil
      loop do
        print "stop loss: "
        stop = Rirera.stop_loss(actual, Rirera.sanity_check($stdin.gets))
        puts "stop loss has to be lower than actual price" if stop.nil?
        break unless stop.nil?
      end
      rrr = Rirera::Order.new(broker, volume, target, actual, stop)
      rrr.print_result
      puts ""
      puts "Again? (y/n)"
      exit if $stdin.gets.chomp == "n"
      @opts.delete_if {|key,value| key != :broker }
    end
  rescue Interrupt => e
      puts ""
      abort "Exit..."
  end
end

def main
  @opts = Trollop::options do
    opt :broker, "choose your broker", :short => 'b', :required => true, :type => String
    opt :volume, "volume (amount of money)", :short => 'v', :type => Float
    opt :target, "target price", :short => 't', :type => Float
    opt :actual, "actual price", :short => 'a', :type => Float
    opt :stop, "stop loss", :short => 's', :type => Float
    opt :loop, "start rirera in loop input mode (other options will be discarded)", :short => 'l'
  end

  if @opts[:loop_given]
    input
  else
    broker = Rirera.get_broker(@opts[:broker])
    volume = @opts[:volume_given] ? @opts[:volume] : abort("missing volume")
    target = @opts[:target_given] ? @opts[:target] : abort("missing target")
    actual = @opts[:actual_given] ? @opts[:actual] : abort("missing actual")
    stop = @opts[:stop_given] ? Rirera.stop_loss(actual,@opts[:stop]) : abort("missing stop")
    abort("stop loss has to be lower than actual price") if stop.nil?
    rrr = Rirera::Order.new(broker, volume, target, actual, stop)
    rrr.print_result
  end
end
main
